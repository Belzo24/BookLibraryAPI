{% extends 'base.html' %}
{% block title %}Books | Book Library{% endblock %}
{% block content %}
<h2>Books</h2>
<div class="form-section">
    <form action = "/home/books/add/" id="addBookForm" method="post">
        <input type="text" id="author_input" name="author_input" placeholder="Enter Author" required>
        <input type="text" id="book" name="book" placeholder="Book Title" required>
        <button type="submit" class="btn fun-btn" name="action" value="submit">Add Book</button>
    </form>
</div>
<table id="booksTable">
    <thead>
        <tr>
            <th>Book</th>
            <th>Book ID</th>
            <th>Author ID</th>
            <th>Update</th>
            <th>Remove</th>
        </tr>
    </thead>
    <tbody>
        {% for item in books %}
        <tr data-id="{{ item.book_id }}">
            <td class="book-name">{{ item.book_name }}</td>
            <td class="book-id">{{ item.book_id }}</td>
            <td class="book-author">{{ item.author_foreign }}</td>
            <td>
                <button class="btn edit-btn" onclick="editRow(this)">Update</button>
                <form action="/home/books/update/" method="POST" class="update-form" style="display:none;">
                    <input type="hidden" name="update" value="{{ item.book_id }}">
                    <input type="text" name="book_name" value="{{ item.book_name }}" required>
                    <input type="text" name="author_key" value="{{ item.author_foreign }}" required>
                    <button type="submit" class="btn save-btn">Save</button>
                    <button type="button" class="btn cancel-btn" onclick="cancelEdit(this)">Cancel</button>
                </form>
            </td>
            <td>
                <form action="/home/books/remove/" method="POST">
                    <input type="hidden" name="data_remove" value="{{ item.book_id }}">
                    <button type="submit" class="btn cancel-btn" name="unalive" value="true">Remove</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const updateForms = document.querySelectorAll('.update-form');

  updateForms.forEach(form => {
    form.addEventListener('submit', async (event) => {
      event.preventDefault(); 

      const formData = new FormData(form);
      const book_id = formData.get('update');
      const bookName = formData.get('book_name');
      const authorForeign = formData.get('author_key');

      const data = {
        book_id: book_id,
        book_name: bookName,
        author_key: authorForeign
      };

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const err = await response.text();
          alert(`Error: ${err}`);
          return;
        }

        const json = await response.json();
        alert('Update successful!');

        const row = form.closest('tr');
        row.querySelector('.book-name').textContent = json.book_name;
        row.querySelector('.book-author').textContent = json.author_name;
        
        cancelEdit(form.querySelector('.cancel-btn'));
      } catch (error) {
        alert('Failed to update book: ' + error);
      }
    });
  });
});


</script>
{% endblock %}
{% block scripts %}

<script>
function editRow(btn) {
    const row = btn.closest('tr');
    row.classList.add('editable-row');
    btn.style.display = 'none';
    row.querySelector('.update-form').style.display = 'inline-block';
}
function cancelEdit(btn) {
    const form = btn.closest('.update-form');
    const row = form.closest('tr');
    row.classList.remove('editable-row');
    row.querySelector('.edit-btn').style.display = 'inline-block';
    form.style.display = 'none';
}
</script>
{% endblock %} 